<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kreativeium: A Sensory Tracking Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style id="custom-styles">
    :root {
        --primary-color: #8A2BE2; /* BlueViolet */
        --secondary-color: #FF69B4; /* HotPink */
        --accent-color: #FFA500; /* Orange */
        --bg-color: #1a1a1a; /* Dark gray, almost black */
        --bg-secondary-color: #2a2a2a; /* Slightly lighter dark gray */
        --text-color: #e0e0e0; /* Light gray for text */
        --text-muted-color: #a0a0a0; /* Muted gray for less important text */
        --success-color: #32CD32; /* LimeGreen */
        --warning-color: #FFD700; /* Gold */
        --error-color: #FF4500; /* OrangeRed */
        --font-family-main: 'Quicksand', sans-serif;
        --shadow-light: rgba(138, 43, 226, 0.3); /* BlueViolet with alpha */
        --shadow-medium: rgba(138, 43, 226, 0.5);
        --shadow-strong: rgba(138, 43, 226, 0.7);
    }

    body {
        font-family: var(--font-family-main);
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        line-height: 1.6;
        overflow-x: hidden; /* Prevent horizontal scroll with sidebar */
    }

    #app {
        display: flex;
        min-height: 100vh;
    }

    .sidebar-icon {
        transition: color 0.3s ease, transform 0.3s ease;
    }

    .sidebar-link:hover .sidebar-icon,
    .sidebar-link.active .sidebar-icon {
        color: var(--primary-color);
        transform: scale(1.1);
    }
    
    .sidebar-link.active {
        background-color: rgba(138, 43, 226, 0.1);
        color: var(--primary-color);
        box-shadow: inset 3px 0 0 var(--primary-color);
    }

    .rainbow-text {
        background: linear-gradient(to right, #9333ea, #ec4899, #f97316);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: rainbow-flow 5s ease-in-out infinite;
    }

    @keyframes rainbow-flow {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    
    /* Tailwind utility for range input color - not directly styleable with TW classes */
    input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 8px;
        background: #4a5568; /* gray-700 */
        border-radius: 5px;
        outline: none;
        cursor: pointer;
    }

    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: var(--primary-color);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 0 5px var(--shadow-light);
    }

    input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: var(--primary-color);
        border-radius: 50%;
        cursor: pointer;
        border: none;
        box-shadow: 0 0 5px var(--shadow-light);
    }

    .page {
        animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .mood-emoji-btn, .energy-level-btn {
        background: transparent;
        border: 2px solid transparent;
        padding: 0.5rem;
        border-radius: 50%;
        transition: all 0.3s ease;
        font-size: 1.75rem; /* Increased size */
        line-height: 1;
    }

    .mood-emoji-btn:hover, .energy-level-btn:hover {
        transform: scale(1.15);
        border-color: var(--primary-color);
    }

    .mood-emoji-btn.selected, .energy-level-btn.selected {
        background-color: var(--primary-color);
        color: white;
        transform: scale(1.1);
        box-shadow: 0 0 15px var(--shadow-medium);
    }

    .trigger-checkbox-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 0.75rem;
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        border: 2px solid transparent;
    }

    .trigger-checkbox-label:hover {
        background-color: rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
    }

    .trigger-checkbox-label input[type="checkbox"] {
        display: none; /* Hide actual checkbox */
    }

    .trigger-checkbox-label .material-symbols-outlined {
        font-size: 2.25rem; /* Larger icons */
        margin-bottom: 0.5rem;
        transition: transform 0.2s ease-in-out;
    }

    .trigger-checkbox-label span {
        font-size: 0.8rem;
        font-weight: 500;
    }

    .trigger-checkbox-label input[type="checkbox"]:checked + .material-symbols-outlined {
        transform: scale(1.1);
        color: var(--primary-color);
    }
    
    .trigger-checkbox-label input[type="checkbox"]:checked ~ span {
        color: var(--primary-color);
        font-weight: 600;
    }

    .trigger-checkbox-label input[type="checkbox"]:checked ~ .material-symbols-outlined {
        color: var(--primary-color);
    }

    .trigger-checkbox-label input[type="checkbox"]:checked {
        /* The parent label gets styled when checkbox is checked */
    }

    .trigger-checkbox-label.selected-trigger {
        border-color: var(--primary-color);
        box-shadow: 0 0 10px var(--shadow-light);
    }
    
    .toast-notification {
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
    }

    .toast-notification.success {
        background-color: var(--success-color);
    }

    .toast-notification.error {
        background-color: var(--error-color);
    }

    .toast-notification.info {
        background-color: var(--primary-color);
    }

    .toast-notification.show {
        opacity: 1;
        transform: translateY(0);
    }

    /* Quest Styling */
    .quest-card {
        background-color: var(--bg-secondary-color);
        border-left: 5px solid var(--primary-color);
        transition: box-shadow 0.3s ease, transform 0.3s ease;
    }

    .quest-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px var(--shadow-light);
    }

    .subtask-item {
        display: flex;
        align-items: center;
        background-color: rgba(255,255,255,0.05);
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem; /* rounded-md */
        margin-bottom: 0.5rem;
    }

    .subtask-item input[type="checkbox"] {
        margin-right: 0.75rem;
        width: 1.1rem; /* Adjust size */
        height: 1.1rem; /* Adjust size */
        accent-color: var(--primary-color);
    }

    .subtask-item label {
        flex-grow: 1;
        transition: color 0.3s ease, text-decoration 0.3s ease;
    }

    .subtask-item input[type="checkbox"]:checked + label {
        text-decoration: line-through;
        color: var(--text-muted-color);
    }

    .quest-progress-bar-bg {
        background-color: var(--bg-color);
        border-radius: 9999px;
        height: 0.75rem;
        overflow: hidden;
    }

    .quest-progress-bar-fg {
        background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        height: 100%;
        border-radius: 9999px;
        transition: width 0.5s ease-in-out;
    }

    .history-item {
        transition: background-color 0.2s ease;
    }
    .history-item:hover {
        background-color: var(--bg-secondary-color);
    }

    .strategy-card {
        background-color: var(--bg-secondary-color);
        border: 1px solid transparent; /* For smooth transition */
        transition: all 0.3s ease;
    }

    .strategy-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px var(--shadow-light);
        border-color: var(--primary-color);
    }

    .tag {
        background-color: var(--primary-color);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
        display: inline-block;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        #app {
            flex-direction: column;
        }
        aside {
            width: 100%;
            height: auto;
            position: sticky;
            top: 0;
            z-index: 40; /* Ensure sidebar is above main content if it overlaps */
        }
        main {
            padding: 1.5rem;
        }
        header h2 {
            font-size: 2.5rem; /* Smaller headers on mobile */
        }
    }

    .material-symbols-outlined.filled {
        font-variation-settings: 'FILL' 1;
    }

    #strategies-submenu {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out;
        opacity: 0;
    }

    #strategies-submenu.open {
        max-height: 500px; /* Adjust as needed */
        opacity: 1;
    }

    #strategies-toggle .material-symbols-outlined.transform {
        transition: transform 0.3s ease-in-out;
    }

    #strategies-toggle.open .material-symbols-outlined.transform {
        transform: rotate(180deg);
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
        width: 10px;
    }
    ::-webkit-scrollbar-track {
        background: var(--bg-secondary-color);
    }
    ::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 5px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: var(--secondary-color);
    }

    /* Chart.js Global Config (applied via script, but good to note) */
    /* Chart.defaults.color = '#e0e0e0'; */
    /* Chart.defaults.borderColor = 'rgba(224, 224, 224, 0.2)'; */

    .chart-container canvas {
        max-height: 300px; /* Or whatever height you prefer */
    }

    /* Additional Quest Form Styling */
    #quest-form input[type="text"], #quest-form textarea {
        transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    #quest-form input[type="text"]:focus, #quest-form textarea:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px var(--shadow-light);
    }

    .remove-subtask-btn:hover span {
        color: var(--error-color);
    }

    .remove-strategy-btn:hover span {
        color: var(--error-color);
    }
    .edit-strategy-btn:hover span {
        color: var(--accent-color);
    }

    /* For SOS button animation */
    #sos-button.sos-active {
        animation: pulse-sos 1.5s infinite;
    }

    @keyframes pulse-sos {
        0% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); /* red-500 */
        }
        70% {
            transform: scale(1.05);
            box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
        }
        100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
        }
    }

    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <div id="app" class="flex h-screen">
        <aside class="w-72 bg-gray-800 p-6 flex-shrink-0 flex flex-col justify-between shadow-2xl">
            <div>
                <div class="flex items-center space-x-3 mb-12">
                    <span class="material-symbols-outlined text-4xl text-purple-400">neurology</span>
                    <h1 class="text-2xl font-bold rainbow-text">Kreativeium</h1>
                </div>
                <nav id="sidebar-nav" class="space-y-2">
                    <a href="#dashboard" class="nav-link sidebar-link flex items-center space-x-4 px-4 py-3 rounded-xl transition-all duration-300">
                        <span class="material-symbols-outlined sidebar-icon">dashboard</span>
                        <span class="font-semibold">Dashboard</span>
                    </a>
                    <a href="#quests" class="nav-link sidebar-link flex items-center space-x-4 px-4 py-3 rounded-xl transition-all duration-300">
                        <span class="material-symbols-outlined sidebar-icon">checklist_rtl</span>
                        <span class="font-semibold">Quest Log</span>
                    </a>
                    <a href="#log" class="nav-link sidebar-link flex items-center space-x-4 px-4 py-3 rounded-xl transition-all duration-300">
                        <span class="material-symbols-outlined sidebar-icon">edit_note</span>
                        <span class="font-semibold">Log Experience</span>
                    </a>
                    <a href="#history" class="nav-link sidebar-link flex items-center space-x-4 px-4 py-3 rounded-xl transition-all duration-300">
                        <span class="material-symbols-outlined sidebar-icon">history</span>
                        <span class="font-semibold">History</span>
                    </a>
                    <div>
                        <a href="#strategies" id="strategies-toggle" class="nav-link sidebar-link flex items-center justify-between space-x-4 px-4 py-3 rounded-xl transition-all duration-300">
                            <div class="flex items-center space-x-4">
                                <span class="material-symbols-outlined sidebar-icon">psychology</span>
                                <span class="font-semibold">Coping Strategies</span>
                            </div>
                            <span class="material-symbols-outlined sidebar-icon transform transition-transform duration-300">expand_more</span>
                        </a>
                        <div id="strategies-submenu" class="hidden mt-1 space-y-1 pl-4 border-l-2 border-purple-500 ml-6">
                            <a href="#strategies" class="nav-link sidebar-link flex items-center space-x-3 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white rounded-md transition-all duration-300 pl-4">
                                <span class="material-symbols-outlined text-base text-purple-300">healing</span>
                                <span>My Strategies</span>
                            </a>
                        </div>
                    </div>
                </nav>
            </div>
            <div class="flex items-center space-x-4 p-4 bg-gray-700 rounded-xl shadow-inner">
                <div class="w-12 h-12 bg-gradient-to-br from-pink-500 to-purple-600 rounded-full flex items-center justify-center">
                    <span class="text-white text-xl font-bold">U</span>
                </div>
                <div>
                    <p class="font-semibold text-gray-50">Mock User</p>
                    <p class="text-xs text-gray-400">Neurodivergent Explorer</p>
                </div>
            </div>
        </aside>

        <main class="flex-1 p-10 overflow-y-auto bg-gradient-to-br from-gray-900 to-gray-800">
            <div id="dashboard-page" class="page">
                <header class="mb-10">
                    <h2 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-400 to-orange-400">Welcome to Your Dashboard</h2>
                </header>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 space-y-8">
                        <div class="bg-gray-800 p-6 rounded-xl shadow-xl hover:shadow-purple-500/30 transition-shadow duration-300">
                            <h3 class="text-2xl font-semibold mb-3 text-purple-400 flex items-center">
                                <span class="material-symbols-outlined mr-2">insights</span>Pattern Discovery
                            </h3>
                            <p class="text-gray-300 mb-4">Log your experiences to uncover connections and understand your unique patterns.</p>
                            <a href="#log" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-semibold py-3 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center space-x-2 shadow-md hover:shadow-lg">
                                <span class="material-symbols-outlined">add_circle</span>
                                <span>Log New Experience</span>
                            </a>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-xl shadow-xl hover:shadow-pink-500/30 transition-shadow duration-300">
                            <h3 class="text-2xl font-semibold mb-3 text-pink-400 flex items-center">
                                <span class="material-symbols-outlined mr-2">notifications_active</span>Recent Insights
                            </h3>
                            <div id="recent-activity-list" class="mt-4 space-y-4">
                                <p class="text-gray-400 italic">Start logging to see your personalized insights here.</p>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 space-y-8">
                        <div class="bg-gray-800 p-6 rounded-xl shadow-xl hover:shadow-orange-500/30 transition-shadow duration-300">
                            <h3 class="text-2xl font-semibold mb-4 text-orange-400 flex items-center">
                                <span class="material-symbols-outlined mr-2">warning</span>Potential Overstimulation Factors
                            </h3>
                            <div class="h-72"><canvas id="triggers-chart"></canvas></div>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-xl shadow-xl hover:shadow-teal-500/30 transition-shadow duration-300">
                            <h3 class="text-2xl font-semibold mb-4 text-teal-400 flex items-center">
                                <span class="material-symbols-outlined mr-2">self_improvement</span>Well-being &amp; Energy Flow
                            </h3>
                            <div class="h-72"><canvas id="moods-chart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="log-page" class="page hidden">
                 <header class="mb-10">
                    <h2 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-400 to-orange-400">Log a New Experience</h2>
                </header>
                 <form id="log-form" class="space-y-8 max-w-4xl mx-auto">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-xl">
                        <h3 class="text-2xl font-semibold mb-4 text-purple-400">How are you feeling?</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                             <div>
                                <label class="font-semibold text-gray-300 mb-3 block">Current Vibe</label>
                                <div id="mood-selector" class="flex justify-around items-center bg-gray-700/50 p-2 rounded-full"></div>
                            </div>
                             <div>
                                <label class="font-semibold text-gray-300 mb-3 block">Energy Level</label>
                                <div id="energy-selector" class="flex justify-around items-center bg-gray-700/50 p-2 rounded-full"></div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-xl">
                         <h3 class="text-2xl font-semibold mb-4 text-pink-400">What's happening around you?</h3>
                         <div id="triggers-selection" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                    </div>
                     <div class="bg-gray-800 p-6 rounded-xl shadow-xl">
                        <h3 class="text-2xl font-semibold mb-4 text-orange-400">Any other details?</h3>
                        <div class="space-y-6">
                            <div>
                                <label class="font-semibold text-gray-300 mb-2 flex justify-between">
                                    <span>Intensity</span>
                                    <span id="intensity-value" class="font-bold text-purple-400">5</span>
                                </label>
                                <input type="range" id="log-intensity" min="1" max="10" value="5" class="w-full">
                            </div>
                             <div>
                                <label class="font-semibold text-gray-300 mb-2 block">Environment</label>
                                <input type="text" id="log-environment" placeholder="e.g., School, Supermarket" class="w-full p-3 bg-gray-700/50 rounded-lg border-2 border-gray-600 focus:border-purple-400 focus:ring-0 transition">
                            </div>
                            <div>
                                <label class="font-semibold text-gray-300 mb-2 block">Coping Strategy / What Helped?</label>
                                <input type="text" id="log-intervention" placeholder="e.g., Headphones, deep pressure" class="w-full p-3 bg-gray-700/50 rounded-lg border-2 border-gray-600 focus:border-purple-400 focus:ring-0 transition">
                            </div>
                            <div>
                                <label class="font-semibold text-gray-300 mb-2 block">Notes</label>
                                <textarea id="log-notes" rows="3" placeholder="Add any extra thoughts..." class="w-full p-3 bg-gray-700/50 rounded-lg border-2 border-gray-600 focus:border-purple-400 focus:ring-0 transition"></textarea>
                            </div>
                        </div>
                     </div>
                     <button type="submit" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-4 px-6 rounded-lg transition-colors duration-300 flex items-center justify-center space-x-2 text-lg shadow-lg hover:shadow-purple-500/40">
                        <span class="material-symbols-outlined">save</span>
                        <span>Save Experience</span>
                    </button>
                 </form>
            </div>

            <div id="quests-page" class="page hidden">
                <header class="mb-10">
                     <h2 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-400 to-orange-400">Your Quest Log</h2>
                </header>
                <div class="bg-gray-800 p-6 rounded-xl shadow-xl hover:shadow-purple-500/30 transition-shadow duration-300 mb-8">
                    <h3 class="text-2xl font-semibold mb-4 text-purple-400 flex items-center">
                        <span class="material-symbols-outlined mr-2">add_task</span>Embark on a New Quest
                    </h3>
                    <form id="quest-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1" for="quest-title">Quest Title</label>
                            <input class="w-full bg-gray-700 text-gray-100 border-gray-600 rounded-md p-2 focus:ring-purple-500 focus:border-purple-500 shadow-sm placeholder-gray-500" id="quest-title" name="questTitle" placeholder="e.g., Conquer the Clutter Mountain" type="text" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Sub-Tasks (Milestones)</label>
                            <div class="space-y-2" id="subtasks-container">
                                <div class="flex items-center space-x-2">
                                    <input class="flex-grow bg-gray-700 text-gray-100 border-gray-600 rounded-md p-2 focus:ring-purple-500 focus:border-purple-500 shadow-sm placeholder-gray-500" name="subtask" placeholder="Break down your quest..." type="text">
                                    <button class="remove-subtask-btn text-red-400 hover:text-red-300 p-1 rounded-full hidden" type="button">
                                        <span class="material-symbols-outlined text-xl">remove_circle_outline</span>
                                    </button>
                                </div>
                            </div>
                            <button class="mt-2 text-sm text-purple-400 hover:text-purple-300 flex items-center" id="add-subtask-btn" type="button">
                                <span class="material-symbols-outlined text-lg mr-1">add_circle_outline</span> Add Sub-Task
                            </button>
                        </div>
                        <button class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-300 flex items-center justify-center space-x-2 shadow-md hover:shadow-lg" type="submit">
                            <span class="material-symbols-outlined">flag</span>
                            <span>Launch Quest</span>
                        </button>
                    </form>
                </div>
                <div>
                    <h3 class="text-3xl font-semibold mb-6 text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-blue-400 flex items-center">
                        <span class="material-symbols-outlined mr-3 text-4xl">dynamic_feed</span>Active Quests
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6" id="quest-list">
                        </div>
                </div>
            </div>

            <div id="history-page" class="page hidden">
                <header class="mb-10">
                    <h2 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-400 to-orange-400">Experience History</h2>
                </header>
                <div class="bg-gray-800 p-6 rounded-xl shadow-xl">
                    <div class="mb-4">
                        <input type="text" id="history-search" placeholder="Search by keyword, trigger, or mood..." class="w-full p-3 bg-gray-700/50 rounded-lg border-2 border-gray-600 focus:border-purple-400 focus:ring-0 transition">
                    </div>
                    <div id="history-list" class="divide-y divide-gray-700">
                       <p class="text-gray-400 p-4">No events found.</p>
                    </div>
                </div>
            </div>

            <div id="strategies-page" class="page hidden">
                 <header class="mb-10 flex justify-between items-center">
                    <h2 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-400 to-orange-400">My Coping Strategies</h2>
                    <button id="sos-button" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-300 flex items-center justify-center space-x-2 shadow-md hover:shadow-lg">
                        <span class="material-symbols-outlined">sos</span>
                        <span>SOS Strategy</span>
                    </button>
                </header>
                <div class="mb-8 flex justify-between items-center">
                    <div class="relative w-full max-w-md">
                        <input id="strategy-search" class="w-full py-3 pl-10 pr-4 bg-gray-800 text-gray-200 rounded-lg border border-gray-700 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition-shadow shadow-md" placeholder="Search strategies..." type="text"/>
                        <span class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</span>
                    </div>
                    <div class="flex space-x-3">
                        <button id="add-strategy-button" class="bg-purple-600 hover:bg-purple-500 text-white font-semibold py-3 px-5 rounded-lg transition-colors duration-300 flex items-center justify-center space-x-2 shadow-md hover:shadow-lg">
                            <span class="material-symbols-outlined">add_circle</span>
                            <span>Add New Strategy</span>
                        </button>
                    </div>
                </div>
                <div id="strategy-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    </div>
            </div>
        </main>
    </div>
    
    <div id="strategy-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-lg m-4 border border-gray-700">
            <h2 id="modal-title" class="text-3xl font-bold mb-6 text-purple-400">Add New Strategy</h2>
            <form id="strategy-form" class="space-y-4">
                <input type="hidden" id="strategy-id">
                <div>
                    <label for="strategy-title" class="font-semibold text-gray-300 mb-1 block">Title</label>
                    <input type="text" id="strategy-title" required class="w-full p-3 bg-gray-700/50 rounded-lg border-2 border-gray-600 focus:border-purple-400 focus:ring-0 transition">
                </div>
                <div>
                    <label for="strategy-description" class="font-semibold text-gray-300 mb-1 block">Description</label>
                    <textarea id="strategy-description" rows="3" class="w-full p-3 bg-gray-700/50 rounded-lg border-2 border-gray-600 focus:border-purple-400 focus:ring-0 transition"></textarea>
                </div>
                 <div>
                    <label for="strategy-tags" class="font-semibold text-gray-300 mb-1 block">Tags (comma separated)</label>
                    <input type="text" id="strategy-tags" placeholder="e.g., calm, focus, anxious" class="w-full p-3 bg-gray-700/50 rounded-lg border-2 border-gray-600 focus:border-purple-400 focus:ring-0 transition">
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="cancel-strategy-button" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg transition-colors">Cancel</button>
                    <button type="submit" class="bg-purple-600 hover:bg-purple-500 text-white font-semibold py-2 px-6 rounded-lg transition-colors">Save Strategy</button>
                </div>
            </form>
        </div>
    </div>
    <div id="toast" class="toast-notification fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg opacity-0 transform translate-y-2 z-50">
        <p id="toast-message"></p>
    </div>

    <script type="module" id="app-logic">
    // --- START Firebase v11 Modular SDK Setup ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
        getFirestore, collection, addDoc, query, where, getDocs, orderBy, serverTimestamp, 
        doc, updateDoc, deleteDoc, Timestamp, runTransaction, writeBatch, limit, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // IMPORTANT: Replace with your actual Firebase project configuration
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Initialize Firebase
    const fbApp = initializeApp(firebaseConfig);
    const fbAuth = getAuth(fbApp);
    const fbDb = getFirestore(fbApp);
    let currentUserId = null;
    // --- END Firebase v11 Modular SDK Setup ---

    // --- START Authentication ---
    onAuthStateChanged(fbAuth, (user) => {
        if (user) {
            currentUserId = user.uid;
            console.log('Successfully signed in anonymously:', currentUserId);
            // Once authenticated, load all data relevant to the user
            loadInitialData(); 
        } else {
            currentUserId = null;
            signInAnonymously(fbAuth).catch(error => {
                console.error("Error signing in anonymously:", error);
                showToast("Could not connect. Please check internet & refresh.", "error", 0); // 0 for persistent
            });
        }
    });

    async function loadInitialData() {
        if (!currentUserId) return;
        await renderDashboardCharts();
        await renderRecentActivities();
        await renderQuests();
        await renderStrategies();
        setupFormListeners();
        setupNavigation();
        setupDynamicContent();
        initializeUIElements();
    }
    // --- END Authentication ---

    // --- START Configuration & Constants ---
    const SENSORY_TRIGGERS = {
        AUDITORY: { id: "AUDITORY", label: "Sounds", icon: "hearing", color: "text-blue-400" },
        VISUAL: { id: "VISUAL", label: "Sights", icon: "visibility", color: "text-pink-400" },
        TACTILE: { id: "TACTILE", label: "Touch", icon: "touch_app", color: "text-green-400" },
        OLFACTORY: { id: "OLFACTORY", label: "Smells", icon: "air", color: "text-yellow-400" },
        GUSTATORY: { id: "GUSTATORY", label: "Tastes", icon: "restaurant", color: "text-orange-400" },
        VESTIBULAR: { id: "VESTIBULAR", label: "Movement", icon: "directions_run", color: "text-purple-400" },
        PROPRIOCEPTION: { id: "PROPRIOCEPTION", label: "Body Sense", icon: "accessibility_new", color: "text-indigo-400" },
        INTEROCEPTION: { id: "INTEROCEPTION", label: "Internal", icon: "thermostat", color: "text-red-400" }
    };

    const MOODS = {
        ECSTATIC: { emoji: "ðŸ¤©", label: "Ecstatic", value: 5, color: "text-yellow-400"},
        HAPPY:    { emoji: "ðŸ˜Š", label: "Happy",    value: 4, color: "text-green-400"},
        NEUTRAL:  { emoji: "ðŸ˜", label: "Neutral",  value: 3, color: "text-blue-400"},
        SAD:      { emoji: "ðŸ˜Ÿ", label: "Sad",      value: 2, color: "text-purple-400"},
        DISTRESSED: { emoji: "ðŸ˜«", label: "Distressed",value: 1, color: "text-red-400"}
    };

    const ENERGY_LEVELS = {
        HIGH:   { icon: "battery_charging_full", label: "High",   value: 3, color: "text-green-500" },
        MEDIUM: { icon: "battery_5_bar", label: "Medium", value: 2, color: "text-yellow-500" },
        LOW:    { icon: "battery_1_bar", label: "Low",    value: 1, color: "text-red-500" }
    };

    const PAGES = {
        DASHBOARD: "dashboard-page",
        LOG: "log-page",
        HISTORY: "history-page",
        QUESTS: "quests-page",
        STRATEGIES: "strategies-page"
    };
    // --- END Configuration & Constants ---

    // --- START UI & Navigation ---
    function showToast(message, type = "info", duration = 3000) {
        const toast = document.getElementById("toast");
        const toastMessage = document.getElementById("toast-message");

        toastMessage.textContent = message;
        toast.className = 'toast-notification fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg opacity-0 transform translate-y-2 z-50'; // Reset classes
        toast.classList.add(type); // success, error, info
        toast.classList.add("show");

        if (duration > 0) {
            setTimeout(() => {
                toast.classList.remove("show");
            }, duration);
        }
    }

    function navigateTo(hash) {
        const newHash = hash.startsWith('#') ? hash : '#' + hash;
        const targetPageId = newHash.substring(1).split('/')[0]; // Allow for sub-routes like #strategies/view/123
        
        document.querySelectorAll(".page").forEach(page => page.classList.add("hidden"));
        const targetPage = document.getElementById(targetPageId + "-page");
        if (targetPage) {
            targetPage.classList.remove("hidden");
        } else {
            document.getElementById("dashboard-page").classList.remove("hidden"); // Default to dashboard
            console.warn(`Page not found for hash: ${newHash}, defaulting to dashboard.`);
        }

        document.querySelectorAll("#sidebar-nav .sidebar-link").forEach(link => {
            if (link.getAttribute("href") === newHash || (newHash.startsWith(link.getAttribute("href")) && link.getAttribute("href") !== '#')) {
                link.classList.add("active");
            } else {
                link.classList.remove("active");
            }
        });

        // Handle strategies submenu based on hash
        const strategiesToggle = document.getElementById('strategies-toggle');
        const strategiesSubmenu = document.getElementById('strategies-submenu');
        if (newHash.startsWith('#strategies')) {
            strategiesToggle.classList.add('active', 'open');
            strategiesSubmenu.classList.add('open');
            strategiesSubmenu.style.maxHeight = strategiesSubmenu.scrollHeight + "px";
            if (targetPageId === "strategies") { // Main strategies link implies "My Strategies"
                 document.querySelector('#strategies-submenu a[href="#strategies"]').classList.add('active');
            }
        } else {
            strategiesToggle.classList.remove('active', 'open');
            strategiesSubmenu.classList.remove('open');
            strategiesSubmenu.style.maxHeight = '0';
        }


        window.location.hash = newHash;
        // Potentially load specific data for the page if not already loaded
        // Example: if (targetPageId === "history") await renderHistory();
    }

    function setupNavigation() {
        document.querySelectorAll(".nav-link").forEach(link => {
            link.addEventListener("click", (e) => {
                e.preventDefault();
                const href = link.getAttribute("href");
                if (href && href !== '#') {
                    navigateTo(href);
                }
            });
        });

        window.addEventListener("hashchange", () => navigateTo(window.location.hash));
    }

    function initializeUIElements() {
        // Mood selector
        const moodSelector = document.getElementById("mood-selector");
        Object.values(MOODS).forEach(mood => {
            const button = document.createElement("button");
            button.type = "button";
            button.className = `mood-emoji-btn ${mood.color}`;
            button.textContent = mood.emoji;
            button.dataset.value = mood.value;
            button.title = mood.label;
            button.addEventListener("click", () => {
                moodSelector.querySelectorAll(".mood-emoji-btn").forEach(btn => btn.classList.remove("selected"));
                button.classList.add("selected");
            });
            moodSelector.appendChild(button);
        });

        // Energy selector
        const energySelector = document.getElementById("energy-selector");
        Object.values(ENERGY_LEVELS).forEach(level => {
            const button = document.createElement("button");
            button.type = "button";
            button.className = `energy-level-btn ${level.color}`;
            button.innerHTML = `<span class="material-symbols-outlined">${level.icon}</span>`;
            button.dataset.value = level.value;
            button.title = level.label;
            button.addEventListener("click", () => {
                energySelector.querySelectorAll(".energy-level-btn").forEach(btn => btn.classList.remove("selected"));
                button.classList.add("selected");
            });
            energySelector.appendChild(button);
        });

        // Triggers selection
        const triggersSelection = document.getElementById("triggers-selection");
        Object.values(SENSORY_TRIGGERS).forEach(trigger => {
            const label = document.createElement("label");
            label.className = "trigger-checkbox-label";
            label.innerHTML = `
                <input type="checkbox" name="triggers" value="${trigger.id}" class="hidden">
                <span class="material-symbols-outlined ${trigger.color}">${trigger.icon}</span>
                <span class="text-xs font-medium">${trigger.label}</span>
            `;
            label.addEventListener('click', (e) => {
                // The checkbox inside will toggle naturally. This is for visual feedback if needed.
                const checkbox = label.querySelector('input[type="checkbox"]');
                // Timeout to allow checkbox state to update before checking
                setTimeout(() => {
                    if (checkbox.checked) {
                        label.classList.add('selected-trigger');
                    } else {
                        label.classList.remove('selected-trigger');
                    }
                }, 0);
            });
            triggersSelection.appendChild(label);
        });

        // Intensity slider value display
        const intensitySlider = document.getElementById("log-intensity");
        const intensityValueDisplay = document.getElementById("intensity-value");
        intensitySlider.addEventListener("input", () => {
            intensityValueDisplay.textContent = intensitySlider.value;
        });

        // Strategies submenu toggle
        const strategiesToggle = document.getElementById('strategies-toggle');
        const strategiesSubmenu = document.getElementById('strategies-submenu');
        strategiesToggle.addEventListener('click', (e) => {
            e.preventDefault(); // Prevent hash change if it's just a toggle
            const isOpen = strategiesToggle.classList.toggle('open');
            strategiesSubmenu.classList.toggle('open');
            if (isOpen) {
                strategiesSubmenu.style.maxHeight = strategiesSubmenu.scrollHeight + "px";
                 // If not already on a strategies page, navigate to the main strategies view
                if (!window.location.hash.startsWith('#strategies')) {
                    navigateTo('#strategies');
                }
            } else {
                strategiesSubmenu.style.maxHeight = '0';
            }
        });
    }
    // --- END UI & Navigation ---

    // --- START Data Handling & Firestore ---
    const EXPERIENCES_COLLECTION = "experiences";
    const QUESTS_COLLECTION = "quests";
    const STRATEGIES_COLLECTION = "strategies";

    // Log Experience
    async function logExperience(data) {
        if (!currentUserId) throw new Error("User not authenticated.");
        try {
            const docRef = await addDoc(collection(fbDb, "users", currentUserId, EXPERIENCES_COLLECTION), {
                ...data,
                timestamp: serverTimestamp()
            });
            showToast("Experience logged successfully!", "success");
            return docRef.id;
        } catch (error) {
            console.error("Error logging experience:", error);
            showToast("Failed to log experience.", "error");
            throw error;
        }
    }

    // Get Experiences
    async function getExperiences(filters = {}) {
        if (!currentUserId) return [];
        let q = query(collection(fbDb, "users", currentUserId, EXPERIENCES_COLLECTION), orderBy("timestamp", "desc"));
        // Add more filters if needed based on `filters` object
        if (filters.searchTerm) {
             // Firestore doesn't support full text search natively on multiple fields easily.
            // For more complex search, consider a third-party service like Algolia or a simpler client-side filter post-fetch.
            // This is a placeholder for a more robust search logic or it implies client-side filtering.
        }
        if (filters.limit) {
            q = query(q, limit(filters.limit));
        }

        const querySnapshot = await getDocs(q);
        return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    // Quest Management
    async function addQuest(title, subtasks) {
        if (!currentUserId) throw new Error("User not authenticated.");
        try {
            const formattedSubtasks = subtasks.map(taskText => ({ text: taskText, completed: false }));
            await addDoc(collection(fbDb, "users", currentUserId, QUESTS_COLLECTION), {
                title,
                subtasks: formattedSubtasks,
                completed: false,
                createdAt: serverTimestamp()
            });
            showToast("Quest launched!", "success");
            renderQuests(); // Re-render quests list
        } catch (error) {
            console.error("Error adding quest:", error);
            showToast("Failed to launch quest.", "error");
        }
    }

    async function updateQuestSubtask(questId, subtaskIndex, completed) {
        if (!currentUserId) throw new Error("User not authenticated.");
        const questRef = doc(fbDb, "users", currentUserId, QUESTS_COLLECTION, questId);
        try {
            await runTransaction(fbDb, async (transaction) => {
                const questDoc = await transaction.get(questRef);
                if (!questDoc.exists()) {
                    throw "Document does not exist!";
                }
                const subtasks = questDoc.data().subtasks;
                subtasks[subtaskIndex].completed = completed;
                transaction.update(questRef, { subtasks: subtasks });
            });
            // Optionally, check if all subtasks are completed and update quest status
            checkAndUpdateQuestCompletion(questId);
        } catch (error) {
            console.error("Error updating subtask:", error);
            showToast("Failed to update subtask.", "error");
        }
    }
    
    async function checkAndUpdateQuestCompletion(questId) {
        if (!currentUserId) return;
        const questRef = doc(fbDb, "users", currentUserId, QUESTS_COLLECTION, questId);
        const questSnap = await getDoc(questRef);
        if (questSnap.exists()) {
            const questData = questSnap.data();
            const allSubtasksCompleted = questData.subtasks.every(st => st.completed);
            if (allSubtasksCompleted !== questData.completed) { // Only update if changed
                await updateDoc(questRef, { completed: allSubtasksCompleted });
                showToast(`Quest "${questData.title}" ${allSubtasksCompleted ? 'completed' : 'marked as active'}!`, "info");
                renderQuests(); // Re-render to reflect completion status
            }
        }
    }

    async function getQuests() {
        if (!currentUserId) return [];
        const q = query(collection(fbDb, "users", currentUserId, QUESTS_COLLECTION), orderBy("createdAt", "desc"));
        const querySnapshot = await getDocs(q);
        return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }
    
    async function deleteQuest(questId) {
        if (!currentUserId) throw new Error("User not authenticated");
        try {
            await deleteDoc(doc(fbDb, "users", currentUserId, QUESTS_COLLECTION, questId));
            showToast("Quest deleted.", "success");
            renderQuests();
        } catch (e) {
            console.error("Error deleting quest: ", e);
            showToast("Error deleting quest.", "error");
        }
    }

    // Coping Strategy Management
    async function saveStrategy(strategyData, strategyId = null) {
        if (!currentUserId) throw new Error("User not authenticated.");
        const userStrategiesCol = collection(fbDb, "users", currentUserId, STRATEGIES_COLLECTION);
        try {
            if (strategyId) {
                // Update existing strategy
                const strategyRef = doc(userStrategiesCol, strategyId);
                await updateDoc(strategyRef, { ...strategyData, lastUpdatedAt: serverTimestamp() });
                showToast("Strategy updated successfully!", "success");
            } else {
                // Add new strategy
                await addDoc(userStrategiesCol, { ...strategyData, createdAt: serverTimestamp() });
                showToast("Strategy added successfully!", "success");
            }
            renderStrategies();
            return true;
        } catch (error) {
            console.error("Error saving strategy:", error);
            showToast(`Failed to save strategy: ${error.message}`, "error");
            return false;
        }
    }

    async function getStrategies() {
        if (!currentUserId) return [];
        const q = query(collection(fbDb, "users", currentUserId, STRATEGIES_COLLECTION), orderBy("createdAt", "desc"));
        const querySnapshot = await getDocs(q);
        return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    async function deleteStrategy(strategyId) {
        if (!currentUserId) throw new Error("User not authenticated.");
        try {
            await deleteDoc(doc(fbDb, "users", currentUserId, STRATEGIES_COLLECTION, strategyId));
            showToast("Strategy deleted.", "success");
            renderStrategies();
        } catch (e) {
            console.error("Error deleting strategy: ", e);
            showToast("Error deleting strategy.", "error");
        }
    }
    // --- END Data Handling & Firestore ---

    // --- START Rendering Content ---
    async function renderDashboardCharts() {
        if (!currentUserId) return;
        const experiences = await getExperiences({limit: 30}); // Get last 30 for chart relevance

        // Triggers Chart (Potential Overstimulation Factors)
        const triggerCounts = {};
        experiences.forEach(exp => {
            exp.triggers?.forEach(triggerId => {
                const triggerLabel = SENSORY_TRIGGERS[triggerId]?.label || triggerId;
                triggerCounts[triggerLabel] = (triggerCounts[triggerLabel] || 0) + 1;
            });
        });

        const triggersChartCtx = document.getElementById('triggers-chart')?.getContext('2d');
        if (triggersChartCtx) {
            if (window.triggersChartInstance) window.triggersChartInstance.destroy();
            window.triggersChartInstance = new Chart(triggersChartCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(triggerCounts),
                    datasets: [{
                        label: 'Frequency',
                        data: Object.values(triggerCounts),
                        backgroundColor: 'rgba(249, 115, 22, 0.6)', // orange-500 with alpha
                        borderColor: 'rgba(249, 115, 22, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { color: '#a0a0a0' }, grid: { color: 'rgba(224, 224, 224, 0.1)'} },
                              x: { ticks: { color: '#a0a0a0' }, grid: { color: 'rgba(224, 224, 224, 0.1)'} } },
                    plugins: { legend: { display: false }, title: { display: false } }
                }
            });
        }

        // Moods Chart (Well-being & Energy Flow - simplified to mood for now)
        const moodCounts = {};
        const moodValuesOverTime = experiences.map(exp => ({
            x: exp.timestamp?.toDate(), // Assumes timestamp is a Firestore Timestamp
            y: exp.mood
        })).sort((a,b) => a.x - b.x); // Sort by date

        const moodsChartCtx = document.getElementById('moods-chart')?.getContext('2d');
        if (moodsChartCtx) {
            if (window.moodsChartInstance) window.moodsChartInstance.destroy();
            window.moodsChartInstance = new Chart(moodsChartCtx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Mood Level (1-5)',
                        data: moodValuesOverTime,
                        borderColor: 'rgba(20, 184, 166, 1)', // teal-500
                        backgroundColor: 'rgba(20, 184, 166, 0.3)',
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'day' }, ticks: { color: '#a0a0a0' }, grid: { color: 'rgba(224, 224, 224, 0.1)'} },
                        y: { beginAtZero: false, min: 1, max: 5, ticks: { color: '#a0a0a0', stepSize: 1 }, grid: { color: 'rgba(224, 224, 224, 0.1)'} }
                    },
                    plugins: { legend: { display: false }, title: { display: false } }
                }
            });
        }
         // Set global chart defaults
        Chart.defaults.color = '#e0e0e0'; // var(--text-color)
        Chart.defaults.borderColor = 'rgba(224, 224, 224, 0.2)';
    }

    async function renderRecentActivities() {
        if (!currentUserId) return;
        const activityList = document.getElementById("recent-activity-list");
        activityList.innerHTML = '<p class="text-gray-400 italic">Loading insights...</p>';
        const experiences = await getExperiences({ limit: 5 });
        if (experiences.length === 0) {
            activityList.innerHTML = '<p class="text-gray-400 italic">Start logging to see your personalized insights here.</p>';
            return;
        }
        activityList.innerHTML = ""; // Clear loading/default message
        experiences.forEach(exp => {
            const moodObj = Object.values(MOODS).find(m => m.value === exp.mood);
            const energyObj = Object.values(ENERGY_LEVELS).find(el => el.value === exp.energyLevel);
            const item = document.createElement("div");
            item.className = "p-3 bg-gray-700/50 rounded-lg shadow-sm hover:bg-gray-700 transition-colors duration-200";
            item.innerHTML = `
                <p class="text-sm font-semibold text-pink-400">
                    ${moodObj ? moodObj.emoji + " " + moodObj.label : 'Mood not specified'}
                    ${energyObj ? '(Energy: ' + energyObj.label + ')' : ''}
                </p>
                <p class="text-xs text-gray-400 mb-1">${exp.timestamp ? exp.timestamp.toDate().toLocaleDateString() : 'Date unknown'}</p>
                <p class="text-xs text-gray-300 truncate">${exp.notes || "No notes."}</p>
                ${exp.triggers && exp.triggers.length > 0 ? 
                    `<div class="mt-1 text-xs text-gray-500">Triggers: ${exp.triggers.map(t_id => SENSORY_TRIGGERS[t_id]?.label || t_id).join(', ')}</div>` : ''}
            `;
            activityList.appendChild(item);
        });
    }

    async function renderHistory() {
        if (!currentUserId) return;
        const historyList = document.getElementById("history-list");
        const searchTerm = document.getElementById("history-search").value.toLowerCase();
        historyList.innerHTML = '<p class="text-gray-400 p-4">Loading history...</p>';
        const experiences = await getExperiences(); // Get all for now, can add pagination later

        const filteredExperiences = experiences.filter(exp => {
            if (!searchTerm) return true;
            const moodObj = Object.values(MOODS).find(m => m.value === exp.mood);
            const triggersStr = exp.triggers?.map(t_id => SENSORY_TRIGGERS[t_id]?.label.toLowerCase() || '').join(' ') || '';
            return (
                (exp.notes && exp.notes.toLowerCase().includes(searchTerm)) ||
                (exp.environment && exp.environment.toLowerCase().includes(searchTerm)) ||
                (moodObj && moodObj.label.toLowerCase().includes(searchTerm)) ||
                triggersStr.includes(searchTerm)
            );
        });

        if (filteredExperiences.length === 0) {
            historyList.innerHTML = '<p class="text-gray-400 p-4">No events found matching your criteria.</p>';
            return;
        }

        historyList.innerHTML = "";
        filteredExperiences.forEach(exp => {
            const moodObj = Object.values(MOODS).find(m => m.value === exp.mood);
            const energyObj = Object.values(ENERGY_LEVELS).find(el => el.value === exp.energyLevel);
            const item = document.createElement("div");
            item.className = "history-item p-4 border-b border-gray-700 last:border-b-0 hover:bg-gray-700/50 cursor-pointer";
            item.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                    <span class="font-semibold ${moodObj ? moodObj.color : 'text-gray-200'}">
                        ${moodObj ? moodObj.emoji + " " + moodObj.label : 'Mood: Not specified'}
                        ${energyObj ? ` <span class="text-xs ${energyObj.color}">(${energyObj.label} Energy)</span>` : ''}
                    </span>
                    <span class="text-xs text-gray-400">${exp.timestamp ? exp.timestamp.toDate().toLocaleString() : 'Date unknown'}</span>
                </div>
                <p class="text-sm text-gray-300 mb-1"><strong>Intensity:</strong> ${exp.intensity || 'N/A'}</p>
                ${exp.environment ? `<p class="text-sm text-gray-300 mb-1"><strong>Environment:</strong> ${exp.environment}</p>` : ''}
                ${exp.triggers && exp.triggers.length > 0 ? 
                    `<p class="text-sm text-gray-300 mb-1"><strong>Triggers:</strong> ${exp.triggers.map(t_id => SENSORY_TRIGGERS[t_id]?.label || t_id).join(', ')}</p>` : ''}
                ${exp.intervention ? `<p class="text-sm text-gray-300 mb-1"><strong>Intervention:</strong> ${exp.intervention}</p>` : ''}
                ${exp.notes ? `<p class="text-sm text-gray-300 mt-2 bg-gray-700 p-2 rounded"><em>${exp.notes}</em></p>` : ''}
            `;
            // Add click listener to show more details or edit later if needed
            historyList.appendChild(item);
        });
    }

    async function renderQuests() {
        if (!currentUserId) return;
        const questListContainer = document.getElementById("quest-list");
        questListContainer.innerHTML = '<p class="text-gray-400 italic col-span-full">Loading quests...</p>';
        const quests = await getQuests();

        if (quests.length === 0) {
            questListContainer.innerHTML = '<p class="text-gray-400 italic col-span-full">No active quests. Time to embark on a new adventure!</p>';
            return;
        }

        questListContainer.innerHTML = "";
        quests.forEach(quest => {
            const card = document.createElement("div");
            card.className = "quest-card bg-gray-800 p-6 rounded-xl shadow-lg border-l-4 border-purple-500 hover:shadow-purple-400/30 transition-all duration-300";
            
            const completedSubtasks = quest.subtasks.filter(st => st.completed).length;
            const totalSubtasks = quest.subtasks.length;
            const progress = totalSubtasks > 0 ? (completedSubtasks / totalSubtasks) * 100 : 0;

            let subtasksHTML = '';
            if (totalSubtasks > 0) {
                subtasksHTML = quest.subtasks.map((subtask, index) => `
                    <div class="subtask-item flex items-center space-x-3 py-2 border-b border-gray-700 last:border-b-0">
                        <input type="checkbox" id="quest-${quest.id}-subtask-${index}" data-quest-id="${quest.id}" data-subtask-index="${index}" ${subtask.completed ? 'checked' : ''} class="form-checkbox h-5 w-5 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500">
                        <label for="quest-${quest.id}-subtask-${index}" class="text-sm ${subtask.completed ? 'line-through text-gray-500' : 'text-gray-300'}">${subtask.text}</label>
                    </div>
                `).join('');
            } else {
                subtasksHTML = '<p class="text-xs text-gray-400 italic">No milestones for this quest yet.</p>';
            }

            card.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-xl font-semibold ${quest.completed ? 'text-green-400 line-through' : 'text-purple-400'}">${quest.title}</h4>
                    <button class="delete-quest-btn text-red-500 hover:text-red-400 transition-colors" data-quest-id="${quest.id}">
                        <span class="material-symbols-outlined">delete_forever</span>
                    </button>
                </div>
                ${totalSubtasks > 0 ? `
                <div class="mb-3">
                    <div class="flex justify-between text-xs text-gray-400 mb-1">
                        <span>Progress</span>
                        <span>${completedSubtasks}/${totalSubtasks}</span>
                    </div>
                    <div class="quest-progress-bar-bg w-full bg-gray-700 rounded-full h-2.5">
                        <div class="quest-progress-bar-fg bg-gradient-to-r from-purple-500 to-pink-500 h-2.5 rounded-full" style="width: ${progress}%"></div>
                    </div>
                </div>
                ` : ''}
                <div class="space-y-2 mt-3">${subtasksHTML}</div>
                ${quest.completed ? '<p class="mt-3 text-sm text-green-400 font-semibold flex items-center"><span class="material-symbols-outlined mr-1">check_circle</span> Quest Completed!</p>' : ''}
            `;
            questListContainer.appendChild(card);

            // Add event listeners for subtask checkboxes
            card.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    updateQuestSubtask(e.target.dataset.questId, parseInt(e.target.dataset.subtaskIndex), e.target.checked);
                });
            });
            // Add event listener for delete button
            card.querySelector('.delete-quest-btn').addEventListener('click', (e) => {
                if (confirm("Are you sure you want to delete this quest?")) {
                    deleteQuest(e.currentTarget.dataset.questId);
                }
            });
        });
    }

    async function renderStrategies() {
        if (!currentUserId) return;
        const strategyList = document.getElementById('strategy-list');
        const searchTerm = document.getElementById('strategy-search').value.toLowerCase();
        strategyList.innerHTML = '<p class="text-gray-400 italic col-span-full">Loading strategies...</p>';
        let strategies = await getStrategies();

        if (searchTerm) {
            strategies = strategies.filter(s => 
                s.title.toLowerCase().includes(searchTerm) || 
                (s.description && s.description.toLowerCase().includes(searchTerm)) ||
                (s.tags && s.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
            );
        }

        if (strategies.length === 0) {
            strategyList.innerHTML = searchTerm 
                ? '<p class="text-gray-400 italic col-span-full">No strategies found matching your search.</p>' 
                : '<p class="text-gray-400 italic col-span-full">No strategies defined yet. Add your first one!</p>';
            return;
        }

        strategyList.innerHTML = '';
        strategies.forEach(strategy => {
            const card = document.createElement('div');
            card.className = "strategy-card bg-gray-800 p-6 rounded-xl shadow-lg hover:shadow-purple-400/30 transition-all duration-300 flex flex-col justify-between";
            let tagsHTML = '';
            if (strategy.tags && strategy.tags.length > 0) {
                tagsHTML = strategy.tags.map(tag => `<span class="tag bg-purple-600 text-xs text-white px-2 py-1 rounded-full">${tag}</span>`).join(' ');
            }

            card.innerHTML = `
                <div>
                    <h4 class="text-xl font-semibold text-purple-300 mb-2">${strategy.title}</h4>
                    <p class="text-sm text-gray-400 mb-3 min-h-[40px]">${strategy.description || 'No description.'}</p>
                    ${tagsHTML ? `<div class="mb-3 flex flex-wrap gap-1">${tagsHTML}</div>` : ''}
                </div>
                <div class="flex justify-end space-x-2 pt-3 border-t border-gray-700 mt-auto">
                    <button class="edit-strategy-btn text-yellow-400 hover:text-yellow-300 p-1" data-id="${strategy.id}">
                        <span class="material-symbols-outlined">edit</span>
                    </button>
                    <button class="remove-strategy-btn text-red-500 hover:text-red-400 p-1" data-id="${strategy.id}">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                </div>
            `;
            strategyList.appendChild(card);

            card.querySelector('.edit-strategy-btn').addEventListener('click', () => openStrategyModal(strategy));
            card.querySelector('.remove-strategy-btn').addEventListener('click', async () => {
                if (confirm('Are you sure you want to delete this strategy?')) {
                    await deleteStrategy(strategy.id);
                }
            });
        });
    }
    // --- END Rendering Content ---

    // --- START Event Listeners & Forms ---
    function setupFormListeners() {
        // Log form submission
        const logForm = document.getElementById("log-form");
        logForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const moodButton = logForm.querySelector("#mood-selector .selected");
            const energyButton = logForm.querySelector("#energy-selector .selected");
            const selectedTriggers = Array.from(logForm.querySelectorAll("#triggers-selection input:checked")).map(cb => cb.value);

            const experienceData = {
                mood: moodButton ? parseInt(moodButton.dataset.value) : null,
                energyLevel: energyButton ? parseInt(energyButton.dataset.value) : null,
                triggers: selectedTriggers,
                intensity: parseInt(document.getElementById("log-intensity").value),
                environment: document.getElementById("log-environment").value.trim(),
                intervention: document.getElementById("log-intervention").value.trim(),
                notes: document.getElementById("log-notes").value.trim(),
            };

            try {
                await logExperience(experienceData);
                logForm.reset();
                // Reset custom UI elements
                logForm.querySelectorAll("#mood-selector .selected, #energy-selector .selected").forEach(btn => btn.classList.remove("selected"));
                logForm.querySelectorAll("#triggers-selection .selected-trigger").forEach(lbl => lbl.classList.remove("selected-trigger"));
                document.getElementById("intensity-value").textContent = "5"; // Reset slider display
                await renderDashboardCharts(); // Update charts on dashboard
                await renderRecentActivities();
                navigateTo('#dashboard'); // Go to dashboard after logging
            } catch (error) {
                // Error already shown by logExperience function
            }
        });

        // Quest form submission
        const questForm = document.getElementById("quest-form");
        const addSubtaskBtn = document.getElementById("add-subtask-btn");
        const subtasksContainer = document.getElementById("subtasks-container");

        const createSubtaskInput = () => {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2 mb-2';
            const input = document.createElement('input');
            input.type = 'text';
            input.name = 'subtask';
            input.placeholder = 'Sub-task description';
            input.className = 'flex-grow bg-gray-700 text-gray-100 border-gray-600 rounded-md p-2 focus:ring-purple-500 focus:border-purple-500 shadow-sm placeholder-gray-500';
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-subtask-btn text-red-400 hover:text-red-300 p-1 rounded-full';
            removeBtn.innerHTML = '<span class="material-symbols-outlined text-xl">remove_circle_outline</span>';
            removeBtn.onclick = () => div.remove();
            div.appendChild(input);
            div.appendChild(removeBtn);
            return div;
        };
        // Initial subtask input (if not already there by HTML)
        if (subtasksContainer.children.length === 0) {
           // subtasksContainer.appendChild(createSubtaskInput()); 
           // HTML provides one by default, let's ensure it has remove if needed
        }
        if (subtasksContainer.children.length > 0 && !subtasksContainer.querySelector('.remove-subtask-btn')) {
             subtasksContainer.querySelectorAll('input[name="subtask"]').forEach(inputField => {
                 if (!inputField.nextElementSibling || !inputField.nextElementSibling.classList.contains('remove-subtask-btn')) {
                    const parentDiv = inputField.closest('.flex');
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'remove-subtask-btn text-red-400 hover:text-red-300 p-1 rounded-full';
                    removeBtn.innerHTML = '<span class="material-symbols-outlined text-xl">remove_circle_outline</span>';
                    removeBtn.onclick = () => parentDiv.remove();
                    if (parentDiv) parentDiv.appendChild(removeBtn);
                 }
             });
        }


        addSubtaskBtn.addEventListener("click", () => {
            const newSubtaskField = createSubtaskInput();
            subtasksContainer.appendChild(newSubtaskField);
            newSubtaskField.querySelector('input').focus();
        });

        questForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const title = questForm.elements.questTitle.value.trim();
            const subtasks = Array.from(questForm.elements.subtask)
                                .map(input => input.value.trim())
                                .filter(text => text !== "");
            if (!title) {
                showToast("Quest title is required.", "error");
                return;
            }
            await addQuest(title, subtasks);
            questForm.reset();
            subtasksContainer.innerHTML = ''; // Clear dynamic subtasks
            // Add back the initial input field structure from HTML if it was specific
            const initialSubtaskHTML = '<div class="flex items-center space-x-2"><input class="flex-grow bg-gray-700 text-gray-100 border-gray-600 rounded-md p-2 focus:ring-purple-500 focus:border-purple-500 shadow-sm placeholder-gray-500" name="subtask" placeholder="Break down your quest..." type="text"><button class="remove-subtask-btn text-red-400 hover:text-red-300 p-1 rounded-full hidden" type="button"><span class="material-symbols-outlined text-xl">remove_circle_outline</span></button></div>';
            subtasksContainer.innerHTML = initialSubtaskHTML;
        });

        // History search
        document.getElementById("history-search").addEventListener("input", () => renderHistory());
        
        // Strategy Search
        document.getElementById('strategy-search').addEventListener('input', () => renderStrategies());

        // Strategy Modal & Form
        const strategyModal = document.getElementById('strategy-modal');
        const strategyForm = document.getElementById('strategy-form');
        const addStrategyButton = document.getElementById('add-strategy-button');
        const cancelStrategyButton = document.getElementById('cancel-strategy-button');
        const modalTitle = document.getElementById('modal-title');

        addStrategyButton.addEventListener('click', () => openStrategyModal());
        cancelStrategyButton.addEventListener('click', () => strategyModal.classList.add('hidden'));
        strategyModal.addEventListener('click', (e) => {
            if (e.target === strategyModal) strategyModal.classList.add('hidden'); // Close on backdrop click
        });

        strategyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('strategy-id').value;
            const title = document.getElementById('strategy-title').value.trim();
            const description = document.getElementById('strategy-description').value.trim();
            const tagsString = document.getElementById('strategy-tags').value.trim();
            const tags = tagsString ? tagsString.split(',').map(tag => tag.trim()).filter(tag => tag) : [];

            if (!title) {
                showToast('Strategy title is required.', 'error');
                return;
            }
            const success = await saveStrategy({ title, description, tags }, id || null);
            if (success) {
                strategyModal.classList.add('hidden');
            }
        });

        // SOS Button
        const sosButton = document.getElementById('sos-button');
        sosButton.addEventListener('click', async () => {
            if (!currentUserId) return showToast("Authenticating... try again shortly.", "info");
            const strategies = await getStrategies();
            if (strategies.length === 0) {
                return showToast("No strategies defined. Add some first!", "warning");
            }
            // Simple SOS: pick a random strategy
            const randomStrategy = strategies[Math.floor(Math.random() * strategies.length)];
            
            sosButton.classList.add('sos-active');
            setTimeout(() => sosButton.classList.remove('sos-active'), 1500); // Animation duration

            showToast(`ðŸ†˜ SOS: ${randomStrategy.title}. ${randomStrategy.description || 'Try this now!'}`, "info", 10000);
        });
    }

    function openStrategyModal(strategy = null) {
        const strategyModal = document.getElementById('strategy-modal');
        const modalTitle = document.getElementById('modal-title');
        strategyForm.reset(); // Clear form
        if (strategy) {
            modalTitle.textContent = 'Edit Strategy';
            document.getElementById('strategy-id').value = strategy.id;
            document.getElementById('strategy-title').value = strategy.title;
            document.getElementById('strategy-description').value = strategy.description || '';
            document.getElementById('strategy-tags').value = strategy.tags ? strategy.tags.join(', ') : '';
        } else {
            modalTitle.textContent = 'Add New Strategy';
            document.getElementById('strategy-id').value = '';
        }
        strategyModal.classList.remove('hidden');
    }

    function setupDynamicContent() {
        // This function can be expanded to handle other dynamic updates
        // Currently, most dynamic updates are handled within specific render functions
    }
    // --- END Event Listeners & Forms ---

    // Initial call to setup the page
    document.addEventListener('DOMContentLoaded', () => {
        if (!fbAuth || !fbDb) {
            console.error("Firebase services not initialized correctly!");
            showToast("Critical error: Firebase services failed. Please refresh.", "error", 0);
            return;
        }
        // Authentication state change will trigger loadInitialData
        // So, initial UI setup that doesn't depend on data can go here.
        // Elements like mood selectors, energy selectors, trigger selectors are data-independent for their structure.
        initializeUIElements(); 
        setupNavigation(); // Setup navigation links and hash changes first
        // Navigate to initial page based on hash or default to dashboard
        // This will be called again by onAuthStateChanged -> loadInitialData which is fine.
        navigateTo(window.location.hash || '#dashboard'); 
        // showToast("Welcome to Kreativeium!", "success", 3000); // Moved to loadInitialData after auth
    });

    console.log("Kreativeium script loaded and executing.");

    </script>
</body>
</html> 